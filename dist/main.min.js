!function(n,t){if("function"==typeof define&&define.amd)define("bobtail-rx",["exports","underscore"],t);else if("undefined"!=typeof exports)t(exports,require("underscore"));else{var e={exports:{}};t(e.exports,n._),n.rx=e.exports}}(this,function(n,t){"use strict";function e(n,t){if(!n)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?n:t}function r(n,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(n,t):n.__proto__=t)}function u(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")}function i(n){if(Array.isArray(n)){for(var t=0,e=Array(n.length);t<n.length;t++)e[t]=n[t];return e}return Array.from(n)}Object.defineProperty(n,"__esModule",{value:!0}),n.transaction=n.smartUidify=n.uidify=n._rxUid=n.basicDiff=n.cellToSet=n.cellToMap=n.cellToArray=n.flatten=n.cast=n.set=n.map=n.array=n.cell=n.autoReactify=n.reactify=n.unlift=n.lift=n.liftSpec=n.DepSet=n.SrcSet=n.ObsSet=n.DepMap=n.SrcMap=n.ObsMap=n.concat=n.IndexedArray=n.DepArray=n.IndexedDepArray=n.MappedDepArray=n.SrcArray=n.ObsArray=n.DepCell=n.SrcCell=n.ObsCell=n.ObsBase=n.subOnce=n.autoSub=n.onDispose=n.snap=n.postLagBind=n.lagBind=n.bind=n.promiseBind=n.asyncBind=n.hideMutationWarnings=n._recorder=n.types=n.allDownstream=n.upstream=n.skipFirst=n.Ev=n._depMgr=n.DepMgr=void 0;var a=function(n){return n&&n.__esModule?n:{default:n}}(t),o=function(){function n(n,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),l=function(){function n(n,t){var e=[],r=!0,u=!1,i=void 0;try{for(var a,o=n[Symbol.iterator]();!(r=(a=o.next()).done)&&(e.push(a.value),!t||e.length!==t);r=!0);}catch(n){u=!0,i=n}finally{try{!r&&o.return&&o.return()}finally{if(u)throw i}}return e}return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return n(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=0,f=function(){return s+=1},c=function(n,t){return new Set([].concat(i(Array.from(n)),i(Array.from(t))))},h=function(n,t){return new Set(Array.from(n).filter(function(n){return t.has(n)}))},v=function(n,t){return new Set(Array.from(n).filter(function(n){return!t.has(n)}))},y=function(n,t){if(!(t in n))throw new Error("object has no key "+t);var e=n[t];return delete n[t],e},p=function(n,t){var e=n.get(t);return n.delete(t),e},d=function(n){var t=void 0,e=void 0;null==n&&(n=[]);var r=null!=Object.create?Object.create(null):{};if(a.default.isArray(n)){var u=!0,i=!1,o=void 0;try{for(var s,f=n[Symbol.iterator]();!(u=(s=f.next()).done);u=!0){var c=l(s.value,2);t=c[0],e=c[1],r[t]=e}}catch(n){i=!0,o=n}finally{try{!u&&f.return&&f.return()}finally{if(i)throw o}}}else for(t in n)e=n[t],r[t]=e;return r},g=function(n){var t=0,e=!0,r=!1,u=void 0;try{for(var i,a=n[Symbol.iterator]();!(e=(i=a.next()).done);e=!0)t+=i.value}catch(n){r=!0,u=n}finally{try{!e&&a.return&&a.return()}finally{if(r)throw u}}return t},b=n.DepMgr=function(){function n(){u(this,n),this.buffering=0,this.buffer=[],this.events=new Set}return o(n,[{key:"transaction",value:function(n){var t=void 0;this.buffering+=1;try{t=n()}finally{if(this.buffering-=1,0===this.buffering){var e=new Set(a.default.flatten(Array.from(this.events).map(function(n){var t=n.downstreamCells;return Array.from(t)}))),r=A.apply(void 0,i(Array.from(e||[])));r.forEach(function(n){return n._shield=!0});try{var u=this.buffer;this.buffer=[],this.events.clear(),u.map(function(n){var t=l(n,2),e=t[0],r=t[1];return e.pub(r)}),r.forEach(function(n){return n.refresh()})}finally{r.forEach(function(n){return n._shield=!1})}}}return t}}]),n}(),_=n._depMgr=new b,m=n.Ev=function(){function n(t,e){u(this,n),this.observable=e,this.init=t,this.subs=d(),this.downstreamCells=new Set}return o(n,[{key:"sub",value:function(n){var t=f();return null!=this.init&&n(this.init()),this.subs[t]=n,t}},{key:"pub",value:function(n){if(_.buffering)_.buffer.push([this,n]),_.events.add(this);else for(var t in this.subs)(0,this.subs[t])(n)}},{key:"unsub",value:function(n){return y(this.subs,n)}},{key:"scoped",value:function(n,t){var e=this.sub(n);try{return t()}finally{this.unsub(e)}}}]),n}(),k=n.skipFirst=function(n){var t=!0;return function(){if(t)return t=!1;for(var e=arguments.length,r=Array(e),u=0;u<e;u++)r[u]=arguments[u];return n.apply(void 0,i(r||[]))}},w=(n.upstream=function(n){var t=Array.from(n.upstreamEvents).map(function(n){return n.observable});return Array.from(new Set(t))},function n(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];if(e.length){var u=Array.from(new Set(a.default.flatten(e.map(function(n){return Array.from(n.onSet.downstreamCells)}))));return a.default.flatten([u,n.apply(void 0,i(Array.from(u||[])))])}return[]}),A=n.allDownstream=function(){for(var n=arguments.length,t=Array(n),e=0;e<n;e++)t[e]=arguments[e];return Array.from(new Set([].concat(t,i(w.apply(void 0,i(t||[])))).reverse())).reverse()},S=function(){function n(){u(this,n),this.stack=[],this.isMutating=!1,this.isIgnoring=!1,this.hidingMutationWarnings=!1,this.onMutationWarning=new m}return o(n,[{key:"record",value:function(n,t){this.stack.length>0&&!this.isMutating&&(0,a.default)(this.stack).last().addNestedBind(n),this.stack.push(n);var e=this.isMutating;this.isMutating=!1;var r=this.isIgnoring;this.isIgnoring=!1;try{return t()}finally{this.isIgnoring=r,this.isMutating=e,this.stack.pop()}}},{key:"sub",value:function(n,t){if(null==t&&(t=function(){return!0}),this.stack.length>0&&!this.isIgnoring){var e=(0,a.default)(this.stack).last();return e.upstreamEvents.add(n),n.downstreamCells.add(e),P(n,function(){for(var n=arguments.length,r=Array(n),u=0;u<n;u++)r[u]=arguments[u];if(t.apply(void 0,i(Array.from(r||[]))))return e.refresh()})}}},{key:"addCleanup",value:function(n){if(this.stack.length>0)return(0,a.default)(this.stack).last().addCleanup(n)}},{key:"hideMutationWarnings",value:function(n){var t=this.hidingMutationWarnings;this.hidingMutationWarnings=!0;try{return n()}finally{this.hidingMutationWarnings=t}}},{key:"fireMutationWarning",value:function(){return console.warn("Mutation to observable detected during a bind context"),this.onMutationWarning.pub(null)}},{key:"mutating",value:function(n){this.stack.length>0&&!this.hidingMutationWarnings&&this.fireMutationWarning();var t=this.isMutating;this.isMutating=!0;try{return n()}finally{this.isMutating=t}}},{key:"ignoring",value:function(n){var t=this.isIgnoring;this.isIgnoring=!0;try{return n()}finally{this.isIgnoring=t}}}]),n}(),O=n.types={cell:"cell",array:"array",map:"map",set:"set"},M=n._recorder=new S,C=(n.hideMutationWarnings=function(n){return M.hideMutationWarnings(n)},n.asyncBind=function(n,t){var e=new z(t,n);return e.refresh(),e}),j=(n.promiseBind=function(n,t){return C(n,function(){return this.record(t).then(this.done)})},n.bind=function(n){return C(null,function(){return this.done(this.record(n))})}),x=(n.lagBind=function(n,t,e){var r=null;return C(t,function(){var t=this;return null!=r&&clearTimeout(r),r=setTimeout(function(){return t.done(t.record(e))},n)})},n.postLagBind=function(n,t){var e=null;return C(n,function(){var n=this,r=this.record(t),u=r.val,i=r.ms;return null!=e&&clearTimeout(e),e=setTimeout(function(){return n.done(u)},i)})},n.snap=function(n){return M.ignoring(n)}),E=n.onDispose=function(n){return M.addCleanup(n)},P=n.autoSub=function(n,t){var e=n.sub(t);return E(function(){return n.unsub(e)}),e},D=(n.subOnce=function(n,t){var e=P(n,k(function(){t.apply(void 0,arguments),n.unsub(e)}));return e},function(){function n(){u(this,n),this.events=[]}return o(n,[{key:"flatten",value:function(){return an(this)}},{key:"subAll",value:function(n){return null==n&&(n=function(){return!0}),this.events.forEach(function(t){return M.sub(t,n)})}},{key:"raw",value:function(){return this._base}},{key:"_mkEv",value:function(n){var t=new m(n,this);return this.events.push(t),t}},{key:"toCell",value:function(){return $.from(this)}},{key:"toArray",value:function(){return nn.from(this)}},{key:"toMap",value:function(){return tn.from(this)}},{key:"toSet",value:function(){return en.from(this)}}]),n}());n.ObsBase=D;var B=n.ObsCell=function(n){function t(n){u(this,t);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._base=null!=n?n:null,r.onSet=r._mkEv(function(){return[null,r._base]}),r._shield=!1,P(r.onSet,function(){return r._refreshAll()}),r}return r(t,D),o(t,[{key:"_refreshAll",value:function(){var n=this.onSet.downstreamCells;if(n.size&&!this._shield){this._shield=!0;var t=A.apply(void 0,i(Array.from(n)||[]));t.forEach(function(n){return n._shield=!0});try{return t.forEach(function(n){return n.refresh()})}finally{t.forEach(function(n){return n._shield=!1}),this._shield=!1}}}},{key:"all",value:function(){var n=this;return this.subAll(function(){return!n._shield}),this._base}},{key:"get",value:function(){return this.all()}},{key:"readonly",value:function(){var n=this;return new z(function(){return n.all()})}},{key:"_update",value:function(n){if(this._base!==n){var t=this._base;return this._base=n,this.onSet.pub([t,n]),t}return this._base}}]),t}(),I=n.SrcCell=function(n){function t(){return u(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,B),o(t,[{key:"update",value:function(n){var t=this;return M.mutating(function(){return t._update(n)})}},{key:"set",value:function(n){return this.update(n)}}]),t}(),z=n.DepCell=function(n){function t(n,r){u(this,t);var i=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,null!=r?r:null));return i.body=null!=n?n:null,i.refreshing=!1,i.nestedBinds=[],i.cleanups=[],i.upstreamEvents=new Set,i}return r(t,B),o(t,[{key:"refresh",value:function(){var n=this;if(!this.refreshing){var t=this._base,e=function(e){return n._base=e,n.onSet.pub([t,n._base])},r=!1,u=null,i=!1,a={record:function(t){if(!n.refreshing){var o=void 0;if(n.disconnect(),r)throw new Error("this refresh has already recorded its dependencies");n.refreshing=!0,r=!0;try{o=M.record(n,function(){return t.call(a)})}finally{n.refreshing=!1}return i&&e(u),o}},done:function(r){if(t!==r)return n.refreshing?(i=!0,u=r):e(r)}};return this.body.call(a)}}},{key:"disconnect",value:function(){var n=this,t=!0,e=!1,r=void 0;try{for(var u,i=this.cleanups[Symbol.iterator]();!(t=(u=i.next()).done);t=!0)(0,u.value)()}catch(n){e=!0,r=n}finally{try{!t&&i.return&&i.return()}finally{if(e)throw r}}var a=!0,o=!1,l=void 0;try{for(var s,f=this.nestedBinds[Symbol.iterator]();!(a=(s=f.next()).done);a=!0)s.value.disconnect()}catch(n){o=!0,l=n}finally{try{!a&&f.return&&f.return()}finally{if(o)throw l}}return this.nestedBinds=[],this.cleanups=[],this.upstreamEvents.forEach(function(t){return t.downstreamCells.delete(n)}),this.upstreamEvents.clear()}},{key:"addNestedBind",value:function(n){return this.nestedBinds.push(n)}},{key:"addCleanup",value:function(n){return this.cleanups.push(n)}}]),t}(),R=n.ObsArray=function(n){function t(n,r){u(this,t),null==n&&(n=[]),null==r&&(r=ln());var i=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i._cells=n,i.diff=r,i.onChange=i._mkEv(function(){return[0,[],i._cells.map(function(n){return n.raw()})]}),i.onChangeCells=i._mkEv(function(){return[0,[],i._cells]}),i._indexed=null,i}return r(t,D),o(t,[{key:"all",value:function(){return M.sub(this.onChange),this._cells.map(function(n){return n.get()})}},{key:"raw",value:function(){return this._cells.map(function(n){return n.raw()})}},{key:"readonly",value:function(){var n=this;return new U(function(){return n.all()})}},{key:"rawCells",value:function(){return this._cells}},{key:"at",value:function(n){return M.sub(this.onChange,function(t){var e=l(t,3),r=e[0],u=e[1],i=e[2];return r<=n&&u.length!==i.length||u.length===i.length&&n<=r+u.length}),null!=this._cells[n]?this._cells[n].get():void 0}},{key:"length",value:function(){return M.sub(this.onChangeCells,function(n){var t=l(n,3),e=(t[0],t[1]),r=t[2];return e.length!==r.length}),this._cells.length}},{key:"size",value:function(){return this.length()}},{key:"map",value:function(n){var t=new W;return P(this.onChangeCells,function(e){var r=l(e,3),u=r[0],i=r[1],a=r[2],o=!0,s=!1,f=void 0;try{for(var c,h=t._cells.slice(u,u+i.length)[Symbol.iterator]();!(o=(c=h.next()).done);o=!0)c.value.disconnect()}catch(n){s=!0,f=n}finally{try{!o&&h.return&&h.return()}finally{if(s)throw f}}var v=a.map(function(t){return j(function(){return n(t.get())})});return t.realSpliceCells(u,i.length,v)}),t}},{key:"transform",value:function(n,t){var e=this;return new U(function(){return n(e.all())},t)}},{key:"filter",value:function(n){return this.transform(function(t){return t.filter(n)})}},{key:"slice",value:function(n,t){return this.transform(function(e){return e.slice(n,t)})}},{key:"reduce",value:function(n,t){return this.all().reduce(n,null!=t?t:this.at(0))}},{key:"reduceRight",value:function(n,t){return this.all().reduceRight(n,null!=t?t:this.at(0))}},{key:"every",value:function(n){return this.all().every(n)}},{key:"some",value:function(n){return this.all().some(n)}},{key:"indexOf",value:function(n,t){return null==t&&(t=0),this.all().indexOf(n,t)}},{key:"lastIndexOf",value:function(n,t){return null==t&&(t=this.length()-1),this.all().lastIndexOf(n,t)}},{key:"join",value:function(n){return null==n&&(n=","),this.all().join(n)}},{key:"first",value:function(){return this.at(0)}},{key:"last",value:function(){return this.at(this.length()-1)}},{key:"indexed",value:function(){var n=this;return null==this._indexed&&(this._indexed=new N,P(this.onChangeCells,function(t){var e=l(t,3),r=e[0],u=e[1],i=e[2];return n._indexed.realSpliceCells(r,u.length,i)})),this._indexed}},{key:"concat",value:function(){for(var n=arguments.length,t=Array(n),e=0;e<n;e++)t[e]=arguments[e];return F.apply(void 0,[this].concat(t))}},{key:"realSpliceCells",value:function(n,t,e){var r=this,u=this._cells.splice.apply(this._cells,[n,t].concat(e)),i=x(function(){return u.map(function(n){return n.get()})}),a=x(function(){return e.map(function(n){return n.get()})});return vn(function(){return r.onChangeCells.pub([n,u,e]),r.onChange.pub([n,i,a])})}},{key:"realSplice",value:function(n,t,e){return this.realSpliceCells(n,t,e.map($))}},{key:"_update",value:function(n,t){var e=this,r=void 0,u=x(function(){return e._cells.map(function(n){return n.get()})}),i=[0,u.length,n];return t=t||this.diff,r=hn(u.length,n,t(u,n)),(null!=r?r:[i]).map(function(n){var t=l(n,3),r=t[0],u=t[1],i=t[2];return e.realSplice(r,u,i)})}}]),t}(),T=n.SrcArray=function(n){function t(){return u(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,R),o(t,[{key:"spliceArray",value:function(n,t,e){var r=this;return M.mutating(function(){return r.realSplice(n,t,e)})}},{key:"splice",value:function(n,t){for(var e=arguments.length,r=Array(e>2?e-2:0),u=2;u<e;u++)r[u-2]=arguments[u];return this.spliceArray(n,t,r)}},{key:"insert",value:function(n,t){return this.splice(t,0,n)}},{key:"remove",value:function(n){var t=(0,a.default)(this.raw()).indexOf(n);if(t>=0)return this.removeAt(t)}},{key:"removeAll",value:function(n){var t=this;return vn(function(){for(var e=(0,a.default)(x(function(){return t.all()})).indexOf(n);e>=0;)t.removeAt(e),e=x(function(){return(0,a.default)(t.all().slice(e))}).indexOf(n)})}},{key:"removeAt",value:function(n){var t=this,e=x(function(){return t.at(n)});return this.splice(n,1),e}},{key:"push",value:function(n){var t=this;return this.splice(x(function(){return t.length()}),0,n)}},{key:"pop",value:function(){var n=this;return this.removeAt(x(function(){return n.length()-1}))}},{key:"put",value:function(n,t){return this.splice(n,1,t)}},{key:"replace",value:function(n){var t=this;return this.spliceArray(0,x(function(){return t.length()}),n)}},{key:"unshift",value:function(n){return this.insert(n,0)}},{key:"shift",value:function(){return this.removeAt(0)}},{key:"update",value:function(n){var t=this;return M.mutating(function(){return t._update(n)})}},{key:"move",value:function(n,t){var e=this;return vn(function(){if(n!==t){var r=x(function(){return e.length()});if(n<0||n>r-1)throw"Source "+n+" is outside of bounds of array of length "+r;if(t<0||t>r)throw"Destination "+t+" is outside of bounds of array of length "+r;var u=x(function(){return e.all()[n]});n>t?(e.removeAt(n),e.insert(u,t)):(e.insert(u,t),e.removeAt(n))}})}},{key:"swap",value:function(n,t){var e=this;return vn(function(){var r=x(function(){return e.length()});if(n<0||n>r-1)throw"i1 "+n+" is outside of bounds of array of length "+r;if(t<0||t>r-1)throw"i2 "+t+" is outside of bounds of array of length "+r;var u=Math.min(n,t),i=Math.max(n,t);return e.move(u,i),e.move(i,u)})}},{key:"reverse",value:function(){var n=this;return this.update(x(function(){return n.all().reverse()})),x(function(){return n.all()})}}]),t}(),W=n.MappedDepArray=function(n){function t(){return u(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return r(t,R),t}(),N=n.IndexedDepArray=function(n){function t(n,r){u(this,t),null==n&&(n=[]);var i=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n,r));return i.is=i._cells.map(function(n,t){return $(t)}),i.onChangeCells=i._mkEv(function(){return[0,[],a.default.zip(i._cells,i.is)]}),i.onChange=i._mkEv(function(){return[0,[],a.default.zip(i.is,x(function(){return i.all()}))]}),i}return r(t,R),o(t,[{key:"map",value:function(n){var t=new W;return P(this.onChangeCells,function(e){var r=l(e,3),u=r[0],i=r[1],a=r[2],o=!0,s=!1,f=void 0;try{for(var c,h=t._cells.slice(u,u+i.length)[Symbol.iterator]();!(o=(c=h.next()).done);o=!0)c.value.disconnect()}catch(n){s=!0,f=n}finally{try{!o&&h.return&&h.return()}finally{if(s)throw f}}var v=a.map(function(t){var e=l(t,2),r=e[0],u=e[1];return j(function(){return n(r.get(),u)})});return t.realSpliceCells(u,i.length,v)}),t}},{key:"realSpliceCells",value:function(n,t,e){for(var r,u=this,i=void 0,o=this._cells.splice.apply(this._cells,[n,t].concat(e)),l=x(function(){return o.map(function(n){return n.get()})}),s=this.is.slice(n+t),f=0;f<s.length;f++)(i=s[f]).set(n+e.length+f);var c=[],h=e.length,v=0<=h;for(i=0;v?i<h:i>h;v?i++:i--)c.push($(n+i));(r=this.is).splice.apply(r,[n,t].concat(c));var y=x(function(){return e.map(function(n){return n.get()})});return vn(function(){return u.onChangeCells.pub([n,o,a.default.zip(e,c)]),u.onChange.pub([n,l,a.default.zip(y,c)])})}}]),t}(),U=n.DepArray=function(n){function t(n,r){u(this,t);var i=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,[],r));return i.f=n,P(j(function(){return Array.from(i.f())}).onSet,function(n){var t=l(n,2),e=(t[0],t[1]);return i._update(e)}),i}return r(t,R),t}(),F=(n.IndexedArray=function(n){function t(n){u(this,t);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._cells=n,r}return r(t,U),o(t,[{key:"map",value:function(n){var t=new W;return P(this._cells.onChange,function(e){var r=l(e,3),u=r[0],i=r[1],a=r[2];return t.realSplice(u,i.length,a.map(n))}),t}}]),t}(),function(){for(var n=new W,t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];var u=e.map(function(n){return un(n,"array")}),i=e.map(function(){return 0});return u.forEach(function(t,e){return P(t.onChange,function(t){var r=l(t,3),u=r[0],a=r[1],o=r[2],s=g(i.slice(0,e));return i[e]+=o.length-a.length,n.realSplice(s+u,a.length,o)})}),n});n.concat=F;var L=function(n){return n instanceof Map?n:a.default.isArray(n)||n instanceof Set?new Map(n):new Map(a.default.pairs(n))},q=n.ObsMap=function(n){function t(n){u(this,t),null==n&&(n=new Map);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._base=L(n),r.onAdd=r._mkEv(function(){return new Map(r._base)}),r.onRemove=r._mkEv(function(){return new Map}),r.onChange=r._mkEv(function(){return new Map}),r}return r(t,D),o(t,[{key:"get",value:function(n){return this.subAll(function(t){return t.has(n)}),this._base.get(n)}},{key:"has",value:function(n){return M.sub(this.onAdd,function(t){return t.has(n)}),M.sub(this.onRemove,function(t){return t.has(n)}),this._base.has(n)}},{key:"all",value:function(){return this.subAll(),new Map(this._base)}},{key:"readonly",value:function(){var n=this;return new G(function(){return n.all()})}},{key:"size",value:function(){return M.sub(this.onRemove),M.sub(this.onAdd),this._base.size}},{key:"_realPut",value:function(n,t){if(this._base.has(n)){var e=this._base.get(n);return e!==t&&(this._base.set(n,t),this.onChange.pub(new Map([[n,[e,t]]]))),e}return this._base.set(n,t),void this.onAdd.pub(new Map([[n,t]]))}},{key:"_realRemove",value:function(n){var t=p(this._base,n);return this.onRemove.pub(new Map([[n,t]])),t}},{key:"_update",value:function(n){var t=this,e=void 0,r=L(n),u=new Map(this._base),i=a.default.chain(Array.from(this._base.keys())).difference(Array.from(r.keys())).map(function(n){return[n,p(t._base,n)]}).value(),o=a.default.chain(Array.from(r.keys())).difference(Array.from(this._base.keys())).map(function(n){return e=r.get(n),t._base.set(n,e),[n,e]}).value(),s=a.default.chain(Array.from(r)).filter(function(n){var e=l(n,2),r=e[0],u=e[1];return t._base.has(r)&&t._base.get(r)!==u}).map(function(n){var e=l(n,2),r=e[0],u=e[1],i=t._base.get(r);return t._base.set(r,u),[r,[i,u]]}).value();return vn(function(){if(i.length&&t.onRemove.pub(new Map(i)),o.length&&t.onAdd.pub(new Map(o)),s.length)return t.onChange.pub(new Map(s))}),u}}]),t}(),J=n.SrcMap=function(n){function t(){return u(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,q),o(t,[{key:"put",value:function(n,t){var e=this;return M.mutating(function(){return e._realPut(n,t)})}},{key:"set",value:function(n,t){return this.put(n,t)}},{key:"delete",value:function(n){var t=this;return M.mutating(function(){var e=void 0;return t._base.has(n)&&(e=t._realRemove(n),t.onRemove.pub(new Map([[n,e]]))),e})}},{key:"remove",value:function(n){return this.delete(n)}},{key:"clear",value:function(){var n=this;return M.mutating(function(){var t=new Map(n._base);return n._base.clear(),t.size&&n.onRemove.pub(t),t})}},{key:"update",value:function(n){var t=this;return M.mutating(function(){return t._update(n)})}}]),t}(),G=n.DepMap=function(n){function t(n){u(this,t);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));r.f=n;var i=j(r.f);return P(i.onSet,function(n){var t=l(n,2),e=(t[0],t[1]);return r._update(e)}),r}return r(t,q),t}(),H=function(n){return n instanceof Set?n:new Set(n)},K=function(n){return n instanceof D&&(n=n.all()),new Set(n)},Q=n.ObsSet=function(n){function t(n){u(this,t),null==n&&(n=new Set);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._base=H(n),r.onChange=r._mkEv(function(){return[r._base,new Set]}),r}return r(t,D),o(t,[{key:"has",value:function(n){return this.subAll(function(t){var e=l(t,2),r=e[0],u=e[1];return r.has(n)||u.has(n)}),this._base.has(n)}},{key:"all",value:function(){return this.subAll(),new Set(this._base)}},{key:"readonly",value:function(){var n=this;return new X(function(){return n.all()})}},{key:"keys",value:function(){return this.all()}},{key:"values",value:function(){return this.all()}},{key:"entries",value:function(){return this.all()}},{key:"size",value:function(){return this.subAll(function(n){var t=l(n,2),e=t[0],r=t[1];return e.size!==r.size}),this._base.size}},{key:"union",value:function(n){var t=this;return new X(function(){return c(t.all(),K(n))})}},{key:"intersection",value:function(n){var t=this;return new X(function(){return h(t.all(),K(n))})}},{key:"difference",value:function(n){var t=this;return new X(function(){return v(t.all(),K(n))})}},{key:"symmetricDifference",value:function(n){var t=this;return new X(function(){return v(t.union(n).all(),t.intersection(n).all())})}},{key:"_update",value:function(n){var t=this;return vn(function(){var e=new Set(t._base),r=H(n),u=new Set,i=new Set;return e.forEach(function(n){if(!r.has(n))return i.add(n)}),r.forEach(function(n){if(!e.has(n))return u.add(n)}),e.forEach(function(n){return t._base.delete(n)}),r.forEach(function(n){return t._base.add(n)}),t.onChange.pub([u,i]),e})}}]),t}(),V=n.SrcSet=function(n){function t(){return u(this,t),e(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,Q),o(t,[{key:"add",value:function(n){var t=this;return M.mutating(function(){return t._base.has(n)||(t._base.add(n),t.onChange.pub([new Set([n]),new Set])),n})}},{key:"put",value:function(n){return this.add(n)}},{key:"delete",value:function(n){var t=this;return M.mutating(function(){return t._base.has(n)&&(t._base.delete(n),t.onChange.pub([new Set,new Set([n])])),n})}},{key:"remove",value:function(n){return this.delete(n)}},{key:"clear",value:function(){var n=this;return M.mutating(function(){var t=new Set(n._base);return n._base.size&&(n._base.clear(),n.onChange.pub([new Set,t])),t})}},{key:"update",value:function(n){var t=this;return M.mutating(function(){return t._update(n)})}}]),t}(),X=n.DepSet=function(n){function t(n){u(this,t);var r=e(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));r.f=n;var i=j(r.f);return P(i.onSet,function(n){var t=l(n,2),e=(t[0],t[1]);return r._update(e)}),r}return r(t,Q),t}(),Y=n.liftSpec=function(n){var t=[],e=void 0,r=void 0,u=!0,i=!1,o=void 0;try{for(var l,s=Object.getOwnPropertyNames(n)[Symbol.iterator]();!(u=(l=s.next()).done);u=!0){var f=l.value;null!=(e=n[f])&&[q,B,R,Q].some(function(n){return e instanceof n})||(r=a.default.isFunction(e)?null:a.default.isArray(e)?"array":e instanceof Set?"set":e instanceof Map?"map":"cell",t.push([f,{type:r,val:e}]))}}catch(n){i=!0,o=n}finally{try{!u&&s.return&&s.return()}finally{if(i)throw o}}return a.default.object(t)},Z=(n.lift=function(n,t){return null==t&&(t=Y(n)),a.default.mapObject(t,function(t,e){var r=t.type;return!(n[e]instanceof D)&&r in O?rn[r](n[e]):n[e]})},n.unlift=function(n){return a.default.mapObject(n,function(n){return n instanceof D?n.all():n})},n.reactify=function n(t,e){var r=void 0;if(a.default.isArray(t)){var u=nn(a.default.clone(t));return Object.defineProperties(t,a.default.object(Object.getOwnPropertyNames(T.prototype).concat(Object.getOwnPropertyNames(R.prototype)).concat(Object.getOwnPropertyNames(D.prototype)).filter(function(n){return"length"!==n}).map(function(n){var e=t[n];return r={configurable:!0,enumerable:!1,value:function(){for(var r,i=void 0,a=arguments.length,o=Array(a),l=0;l<a;l++)o[l]=arguments[l];return null!=e&&(i=e.call.apply(e,[t].concat(o))),(r=u[n]).call.apply(r,[u].concat(o)),i},writable:!0},[n,r]}))),t}return Object.defineProperties(t,a.default.object(function(){var t=[];for(var u in e)r=e[u],t.push(function(t,e){var r=null;switch(e.type){case"cell":var u=$(null!=e.val?e.val:null);r={configurable:!0,enumerable:!0,get:function(){return u.get()},set:function(n){return u.set(n)}};break;case"array":var a=n(null!=e.val?e.val:[]);r={configurable:!0,enumerable:!0,get:function(){return a.all(),a},set:function(n){return a.splice.apply(a,[0,a.length].concat(i(n))),a}};break;default:throw new Error("Unknown observable type: "+e.type)}return[t,r]}(u,r));return t}()))}),$=(n.autoReactify=function(n){var t=[],e=!0,r=!1,u=void 0;try{for(var i,o=Object.getOwnPropertyNames(n)[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var l=i.value,s=n[l];if(!(s instanceof D)){var f=a.default.isFunction(s)?null:a.default.isArray(s)?"array":"cell";t.push([l,{type:f,val:s}])}}}catch(n){r=!0,u=n}finally{try{!e&&o.return&&o.return()}finally{if(r)throw u}}Z(n,a.default.object(t))},n.cell=function(n){return new I(n)});$.from=function(n){return n instanceof B?n:j(n instanceof D?function(){return n.all()}:function(){return n})};var nn=n.array=function(n,t){return new T((null!=n?n:[]).map($),t)};nn.from=function(n,t){var e=void 0;if(n instanceof R)return n;if(a.default.isArray(n))e=function(){return n};else{if(!(n instanceof D))throw new Error("Cannot cast "+n.constructor.name+" to array!");e=function(){return n.all()}}return new U(e,t)};var tn=n.map=function(n){return new J(n)};tn.from=function(n){return n instanceof q?n:new G(n instanceof D?function(){return n.all()}:function(){return n})};var en=n.set=function(n){return new V(n)};en.from=function(n){return n instanceof Q?n:new X(n instanceof D?function(){return n.all()}:function(){return n})};var rn={cell:$,array:nn,map:tn,set:en},un=n.cast=function n(t,e){if(null==e&&(e="cell"),[B,R,q,Q].includes(e)){var r=null;switch(e){case B:r="cell";break;case R:r="array";break;case q:r="map";break;case Q:r="set"}e=r}if(a.default.isString(e))return e in O?rn[e].from(t):t;var u=t,i=e;return a.default.mapObject(u,function(t,e){return i[e]?n(t,i[e]):t})},an=function(n){return new U(function(){return a.default.chain(on([n])).flatten().filter(function(n){return null!=n}).value()})};n.flatten=an;var on=function n(t){return t instanceof R?n(t.all()):t instanceof Q?n(Array.from(t.values())):t instanceof B?n(t.get()):t instanceof Set?n(Array.from(t)):a.default.isArray(t)?t.map(function(t){return n(t)}):t},ln=(n.cellToArray=function(n,t){return new U(function(){return n.get()},t)},n.cellToMap=function(n){return new G(function(){return n.get()})},n.cellToSet=function(n){return new X(function(){return n.get()})},n.basicDiff=function(n){return null==n&&(n=cn),function(t,e){var r=d(t.map(function(t,e){return[n(t),e]})),u=void 0;return e.map(function(t){return null!=(u=r[n(t)])?u:-1})}}),sn=n._rxUid=Symbol("rx uid"),fn=n.uidify=function(n){return null!=n[sn]?n[sn]:Object.defineProperty(n,sn,{enumerable:!1,value:f()})[sn]},cn=n.smartUidify=function(n){return a.default.isObject(n)?fn(n):JSON.stringify(n)},hn=function(n,t,e){var r=void 0;if(!t.length)return null;var u=e.filter(function(n){return n>=0}),i=u.length-1,o=0<=i,l=[];for(r=0;o?r<i:r>i;o?r++:r--)l.push(u[r+1]-u[r]<=0);if(l.some(a.default.identity))return null;var s=[],f=-1;for(r=0;r<e.length;){for(;r<e.length&&e[r]===f+1;)f+=1,r+=1;for(var c={index:r,count:0,additions:[]};r<e.length&&-1===e[r];)c.additions.push(t[r]),r+=1;var h=r===e.length?n:e[r];c.count=h-(f+1),(c.count>0||c.additions.length>0)&&s.push([c.index,c.count,c.additions]),f=h,r+=1}return s},vn=n.transaction=function(n){return _.transaction(n)}});